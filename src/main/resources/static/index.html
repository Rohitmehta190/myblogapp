<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 20px; background:#f7f7f9; }
    h1 { margin-bottom: 10px; }
    .container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    input, textarea, button { width: 100%; padding: 10px; margin: 6px 0; border-radius: 8px; border: 1px solid #ddd; }
    button { cursor: pointer; border: none; background: #3b82f6; color: white; font-weight: 600; }
    button:hover { opacity: .95; }
    .post { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .post:hover { background: #fafafa; }
    .muted { color: #666; font-size: 12px; }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .actions { display: flex; gap: 6px; }
    .danger { background: #ef4444; }
    .comment { padding: 8px 0; border-bottom: 1px dashed #eee; }
  </style>
</head>
<body>
  <h1>Simple Blog</h1>
  <div class="container">
    <!-- Left: Create Post + List -->
    <div>
      <div class="card">
        <h3>Create Post</h3>
        <input id="title" placeholder="Title" />
        <input id="author" placeholder="Author name" />
        <textarea id="content" rows="6" placeholder="Write something..."></textarea>
        <button onclick="createPost()">Publish</button>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>All Posts</h3>
        <div id="posts"></div>
      </div>
    </div>

    <!-- Right: Post details + comments -->
    <div class="card">
      <div id="details">
        <p>Select a post to view details.</p>
      </div>
    </div>
  </div>

  <script>
    const api = {
      posts: '/api/posts'
    };

    async function fetchJSON(url, options={}) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) throw new Error(await res.text());
      return res.json().catch(() => ({}));
    }

    async function loadPosts() {
      const posts = await fetchJSON(api.posts);
      const container = document.getElementById('posts');
      container.innerHTML = '';
      posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
      posts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <strong>${escapeHtml(p.title)}</strong>
          <div class="muted">by ${escapeHtml(p.author || 'Anonymous')} • ${formatDate(p.createdAt)}</div>
        `;
        div.onclick = () => showPost(p.id);
        container.appendChild(div);
      });
    }

    async function createPost() {
      const title = document.getElementById('title').value.trim();
      const author = document.getElementById('author').value.trim();
      const content = document.getElementById('content').value.trim();
      if (!title || !content) { alert('Title and content are required'); return; }
      await fetchJSON(api.posts, { method: 'POST', body: JSON.stringify({ title, author, content }) });
      document.getElementById('title').value = '';
      document.getElementById('author').value = '';
      document.getElementById('content').value = '';
      await loadPosts();
    }

    async function showPost(id) {
      const p = await fetchJSON(`${api.posts}/${id}`);
      const comments = await fetchJSON(`${api.posts}/${id}/comments`);
      const details = document.getElementById('details');
      details.innerHTML = `
        <h2>${escapeHtml(p.title)}</h2>
        <div class="muted">by ${escapeHtml(p.author || 'Anonymous')} • ${formatDate(p.createdAt)}</div>
        <p>${escapeHtml(p.content).replace(/\n/g,'<br/>')}</p>

        <div class="actions">
          <button class="danger" onclick="deletePost(${p.id})">Delete Post</button>
        </div>

        <h3 style="margin-top: 20px;">Comments</h3>
        <div id="comments">
          ${comments.map(c => `
            <div class="comment">
              <strong>${escapeHtml(c.name || 'Guest')}</strong>
              <div class="muted">${formatDate(c.createdAt)}</div>
              <div>${escapeHtml(c.content).replace(/\n/g,'<br/>')}</div>
            </div>
          `).join('')}
        </div>

        <h4>Add a comment</h4>
        <div class="row">
          <input id="cname" placeholder="Your name" />
        </div>
        <textarea id="ccontent" rows="3" placeholder="Your comment"></textarea>
        <button onclick="addComment(${p.id})">Comment</button>
      `;
    }

    async function addComment(postId) {
      const name = document.getElementById('cname').value.trim();
      const content = document.getElementById('ccontent').value.trim();
      if (!content) { alert('Comment content is required'); return; }
      await fetchJSON(`${api.posts}/${postId}/comments`, { method: 'POST', body: JSON.stringify({ name, content }) });
      await showPost(postId);
    }

    async function deletePost(id) {
      if (!confirm('Delete this post?')) return;
      const res = await fetch(`/api/posts/${id}`, { method: 'DELETE' });
      if (res.status === 204) {
        document.getElementById('details').innerHTML = '<p>Post deleted.</p>';
        await loadPosts();
      } else {
        alert('Failed to delete');
      }
    }

    // helpers
    function formatDate(d) {
      if (!d) return '';
      return new Date(d).toLocaleString();
    }
    function escapeHtml(str='') {
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    loadPosts().catch(err => console.error(err));
  </script>
</body>
</html>
